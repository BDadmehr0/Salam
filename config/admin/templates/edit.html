<!DOCTYPE html>
<html lang="en-US" dir="ltr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Edit {{ filename }}</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
</head>
<body>
    <div class="container mt-4">
        <h1>Edit File: {{ filename }}</h1>

        {% if message %}
            <div class="alert {% if message_type == 'ok' %}alert-success{% else %}alert-danger{% endif %}" role="alert">
                {{ message }}
            </div>
        {% endif %}

        <table class="table table-bordered" id="data-table">
            <thead>
                <tr>
                    {% for column in columns %}
                        <th>{{ column }}</th>
                    {% endfor %}
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for item in data %}
                <tr>
                    {% for column in columns %}
                        <td>
                            {% if column in item %}
                                {% if column == "text" %}
                                    <div class="{{ column }}-inputs languages">
                                        {% for lang in languages %}
                                            {% if item[column][lang] is string %}
                                                <div class="language">
                                                    <input class="form-control" value="{{ item[column][lang] }}" />
                                                    <button class="btn btn-danger btn-sm" onclick="deleteLanguageInput(this, '{{ lang }}')">Delete</button>
                                                </div>
                                            {% elif item[column][lang] is iterable %}
                                                {% for val in item[column][lang] %}
                                                    <div class="language">
                                                        <input class="form-control" value="{{ val }}" />
                                                        <button class="btn btn-danger btn-sm" onclick="deleteLanguageInput(this, '{{ lang }}')">Delete</button>
                                                    </div>
                                                {% endfor %}
                                            {% endif %}
                                            <button class="btn btn-primary btn-sm" onclick="addLanguageInput(this, '{{ lang }}')">Add</button>
                                        {% endfor %}
                                    </div>
                                {% else %}
                                    <input class="form-control" value="{{ item[column] }}" />
                                {% endif %}
                            {% else %}
                                <input class="form-control" value="" />
                            {% endif %}
                        </td>
                    {% endfor %}
                    <td>
                        <button class="btn btn-danger btn-sm" onclick="deleteRow(this)">Delete</button>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        <button class="btn btn-success" onclick="addRow()">Add Row</button>
        <button class="btn btn-primary" onclick="save()">Save Changes</button>
    </div>

    <script>
        function deleteLanguageInput() {

        }
        // Add a new input field for arrays dynamically (for text keys like 'en' and 'fa')
        function addText(column, button) {
            const inputGroup = button.closest('td').querySelector(`.${column}-inputs`);
            const input = document.createElement('input');
            input.classList.add('form-control');
            input.type = 'text';
            input.value = '';
            inputGroup.insertBefore(input, button);
        }

        // Add a new row to the table
        function addRow() {
            const table = document.getElementById('data-table').querySelector('tbody');
            const row = document.createElement('tr');
            
            let rowContent = '';
            {% for column in columns %}
                rowContent += `<td>
                    <div class="${column}-inputs">
                        <input class="form-control" value="" />
                        <button class="btn btn-secondary btn-sm" onclick="addText('${column}', this)">Add</button>
                    </div>
                </td>`;
            {% endfor %}
            rowContent += '<td><button class="btn btn-danger btn-sm" onclick="deleteRow(this)">Delete</button></td>';

            row.innerHTML = rowContent;
            table.appendChild(row);
        }

        // Delete a row from the table
        function deleteRow(button) {
            button.closest('tr').remove();
        }

        // Save the changes to the server
        function save() {
            const rows = document.getElementById('data-table').querySelectorAll('tbody tr');
            const items = Array.from(rows).map(row => {
                const cells = row.querySelectorAll('input');
                const item = {};
                {% for column in columns %}
                    const inputs = row.querySelectorAll(`.${column}-inputs input`);
                    const values = Array.from(inputs).map(input => input.value);
                    item["{{ column }}"] = values.length > 1 ? values : values[0];
                {% endfor %}
                return item;
            });

            // Send the data to the backend using axios
            axios.post(window.location.pathname, { items })
                .then(response => alert('Saved successfully!'))
                .catch(error => alert('Failed to save.'));
        }
    </script>
</body>
</html>
